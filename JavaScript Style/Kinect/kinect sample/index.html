<html>
<head>
<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
<script>
var socket = io.connect('http://localhost:8000/');
socket.on('bodyFrame', interpretData);
var trans = 1;
var vertShift = 0;
var transnum = 1;
var transdenom =1;
var horzShift=0;
var oldLeftX;
var oldLeftY;
var oldLeftZ;
var oldRightX;
var oldRightY;
var oldRightZ;;
var prevStateUngripped = true;
var prevStateOnegripped = true;
var prevStateUnlasso = true;
var ungrippedColor = "rgb(128,128,128)";
var grippedColor = "rgb(11,153,11)";
//var graphColor = "rgb(128,128,128)";
var graphColor;

var xChange = 0;

var left =[];
var right =[];

function getURLParameter(name) {
  return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
}
var graphType = getURLParameter("type");
console.log(graphType);

function typeDetermination(){
if (graphType == "menu"){
	console.log("Loading menu...");
	var loadin = document.createElement("content");
	loadin.innerHTML='<object type="text/html" data="Menu.html" width = 2000 height = 1200> </object>';
	document.body.appendChild(loadin);
}
if (graphType == "parabola"){
	console.log("Loading parabola");
	var loadin = document.createElement("script");
	loadin.src = "parabola.js";
	document.body.appendChild(loadin);
	}
else if(graphType == "line"){
	console.log("Loading line");
	var loadin = document.createElement("script");
	loadin.src = "line.js";
	document.body.appendChild(loadin);
}
else if(graphType == "hyperbola"){
	console.log("Loading hyperbola");
	var loadin = document.createElement("script");
	loadin.src = "hyperbola.js";
	document.body.appendChild(loadin);
}
else if(graphType == "ellipse"){
	console.log("Loading ellipse");
	var loadin = document.createElement("script");
	loadin.src = "ellipse.js";
	document.body.appendChild(loadin);
}
}

function interpretData(bodyFrame) {
    // Web Socket message:
	var user;
	
	var transmode = false;
	// assigns a specific body to be the user
	for(i=0; i<=7;i++){
	if (bodyFrame.bodies[i]){
		user=bodyFrame.bodies[i];
		userGlobal = user;
	}
	//determines the state of the right hand
	switch (user.rightHandState)
    {
        case 2:
			document.getElementById("grab").innerHTML = "Right is open";
			right.unshift(hand);
			prevStateUngripped = true;
			prevStateOnegripped = true;
			delete right[1];
			break;
        case 3:
			document.getElementById("grab").innerHTML = "Right is closed";
			right.unshift(rgrip);
			delete right[1];
			
			//contraction();
            break;
        case 4:
			document.getElementById("grab").innerHTML="Translation Mode: Right"
			
            break;
        case 0:
			//document.getElementById("grab").innerHTML = "I dont know what your doing with your right hand";
            break;
        case 1:
            break;
        default:
            break;
    }
	
	//determines the state of the left hand
    switch (user.leftHandState)
    {
        case 2:
			document.getElementById("grab1").innerHTML = "left is open";
			
			left.unshift(lhand);
			delete left[1];
			prevStateUngripped = true;
			prevStateUnlasso = true;
            break;
        case 3:
			document.getElementById("grab1").innerHTML = "left is closed";
			
			left.unshift(lgrip);
			delete left[1];
			
			//dilation();
            break;
        case 4:
			document.getElementById("grab1").innerHTML="Translation Mode: Left"
            break;
        case 0:
			//document.getElementById("grab1").innerHTML = "I dont know what your doing with your left hand"; 
            break;
        case 1:
            break;
        default:
            break;
    } 
	
	//next segment attempts to determine and track the position of the right and left hands and display that in the html body
	try{
	var ctx = canvas.getContext("2d");	
		
	var rightHandPositionX = user.joints[11].depthX;
	var rightHandPositionY = user.joints[11].depthY;
	var rightHandPositionZ = user.joints[11].cameraZ;

	
	var leftHandPositionX = user.joints[7].depthX;
	var leftHandPositionY = user.joints[7].depthY;
	var leftHandPositionZ = user.joints[7].cameraZ;
	var leftShoulderX = user.joints[4].depthX;
	var leftShoulderY = user.joints[4].depthY;
	neitherState(user);
	document.getElementById("dab").innerHTML = rightHandPositionX+"X , "+rightHandPositionY+" Y";
	document.getElementById("dab1").innerHTML = leftHandPositionX+"X , "+leftHandPositionY+" Y | and the shoulder is X " + leftShoulderX +", Y " +leftShoulderY;
	
	//draws filled rectangles at the position of the hands
	//ctx.fillRect(leftHandPositionX*canvasWidth, leftHandPositionY*canvasHeight,5,5);
	
	if(isBothGripped(user)) {
		//console.log("Both gripped");
		//color graph green when gripped
		graphColor = grippedColor;
		
		if(prevStateUngripped){
			oldRight = user.joints[11].depthX;
			oldLeft = user.joints[7].depthX;
		}
		
		prevStateUngripped = false;
		
		if (isMovingApart(user)) {
			dilation();
			}
		else if(isMovingTogether(user)) {
			contraction();
		}
		}
		
	else if(onlyOneGripped(user)){
		//color graph grey when only one hand gripped
		graphColor = ungrippedColor;
		
		if(user.rightHandState ==  3){
			if(prevStateOnegripped){
				oldRightX = user.joints[11].depthX;
				oldRightY = user.joints[11].depthY;
				oldRightZ = user.joints[11].cameraZ;
				prevStateOnegripped=false;
			}
			
			if(Math.abs(rightHandPositionZ-oldRightZ)>.2){
				document.getElementById("dab1").innerHTML ="CLICK!";
				document.elementFromPoint(rightHandPositionX*canvasWidth, rightHandPositionY*canvasHeight).click();
				//ctx.fillRect(rightHandPositionX*canvasWidth, RightHandPositionY*canvasHeight,5,5);
		}
		}
		else if(user.leftHandState == 3){
			if(prevStateOnegripped){
				oldLeftX = user.joints[7].depthX;
				oldLeftY = user.joints[7].depthY;
				oldLeftZ = user.joints[7].cameraZ;
				prevStateOnegripped=false;
			}
			
			
		if(Math.abs(leftHandPositionZ-oldLeftZ)>.2){
			document.getElementById("dab1").innerHTML="CLICK!";
			document.elementFromPoint(leftHandPositionX*canvasWidth, leftHandPositionY*canvasHeight).click();
			//ctx.fillRect(leftHandPositionX*canvasWidth, leftHandPositionY*canvasHeight,5,5);
			
		}
		}
	}
	else if(isLassoed(user)){
		if(prevStateUnlasso){
			if(user.rightHandState ==  4){
				oldRightX = user.joints[11].depthX;
				oldRightY = user.joints[11].depthY;
				
				
			}
			else if(user.leftHandState == 4){
				oldLeftX = user.joints[7].depthX;
				oldLeftY = user.joints[7].depthY;
		}
		prevStateUnlasso = false;
		}
		console.log("right = " + user.joints[11].depthX + " vs " + oldRight);
		console.log("translating...");
		
		if(user.rightHandState == 4){
			if(user.joints[11].depthX< oldRightX){translateRight();}
			if(user.joints[11].depthX> oldRightX){translateLeft();}
			if(user.joints[11].depthY< oldRightY){translateUp();}
			if(user.joints[11].depthY> oldRightY){translateDown();}
		}
		
		if(user.leftHandState == 4){
			console.log("left");
			if(user.joints[7].depthX> oldLeftX){translateRight();}
			if(user.joints[7].depthX< oldLeftX){translateLeft();}
			if(user.joints[7].depthYY< oldLeftY){translateUp();}
			if(user.joints[7].depthY> oldLeftY){translateDown();}
		}
		//color graph green when lassoed
		graphColor = grippedColor;
		
		
	
		
	}
	//color graph grey when neither hand is gripped
	else graphColor = ungrippedColor;
		
	//this block handles translation
	
	
	//cleans canvas each frame and redraws hand images
	ctx.clearRect(0,0,canvasWidth,canvasHeight);
	if(imageLoaded){
		ctx.drawImage(left[0], leftHandPositionX*canvasWidth, leftHandPositionY*canvasHeight);
		ctx.drawImage(right[0], rightHandPositionX*canvasWidth, rightHandPositionY*canvasHeight);
		showAxes(ctx,axes);
		funGraph(ctx,axes,fun1,graphColor,8);
		msg = getFormula();
		ctx.font="25px Arial"
		ctx.fillText(msg,10,30);

	
	}
	
	}
	catch(exception){
	}
	
	

}

//check to make sure both hands in gripped state
//gripped state is state 3
function isBothGripped(user) {
	//console.log("in both gripped funct");
	return (user.leftHandState == 3 && user.rightHandState == 3);
}

function isLassoed(user){
	return ((user.leftHandState == 4)||(user.rightHandState ==4));
}

//check to see if hands are moving apart
function isMovingApart(user) {
	var changeL = oldLeft - user.joints[7].depthX;
	var changeR = oldRight - user.joints[11].depthX;
	xChange = Math.abs(changeL) + Math.abs(changeR);
	//console.log("r " + changeR);
	//console.log("l " + changeL);
	if (changeL > 0 && changeR < 0) {
		return true;
	}
	else {
		return false;
	}

}

//check to see if hands are moving together
function isMovingTogether(user) {
//console.log("in ismovingtogether");
	var changeL = oldLeft - user.joints[7].depthX;
	var changeR = oldRight - user.joints[11].depthX;
	//console.log("r " + changeR);
	//console.log("l " + changeL);
	if (changeL < 0 && changeR > 0) {
		return true;
	}
	else {
		return false;
	}

}
function neitherState(user){
	if (user.leftHandState==2 && user.rightHandState==2){
		prevStateUngripped = true;
		prevStateUnlasso = true;
	}
}

function onlyOneGripped(user){
	if((user.leftHandState!=3 && user.rightHandState==3)|| (user.leftHandState==3 && user.rightHandState!=3)){
	return(true);
	}
	else{
	return(false);
	}
}

 
function funGraph (ctx,axes,func,color,thick) {
 var xx, yy, dx=4, x0=axes.x0, y0=axes.y0, scale=axes.scale;
 var iMax = Math.round((ctx.canvas.width-x0)/dx);
 var iMin = axes.doNegativeX ? Math.round(-x0/dx) : 0;
 ctx.beginPath();
 ctx.lineWidth = thick;
 ctx.strokeStyle = color;

 for (var i=iMin;i<=iMax;i++) {
  xx = dx*i; yy = scale*func(xx/scale);
  if (i==iMin) ctx.moveTo(x0+xx,y0-yy);
  else		   ctx.lineTo(x0+xx,y0-yy);
 }
 ctx.stroke();
}

//draw the axes
function showAxes(ctx,axes) {
 var x0=axes.x0, w=ctx.canvas.width;
 var y0=axes.y0, h=ctx.canvas.height;
 var xmin = axes.doNegativeX ? 0 : x0;
 ctx.beginPath();
 ctx.lineWidth = 1;
 ctx.strokeStyle = "rgb(128,128,128)"; 
 ctx.moveTo(xmin,y0); ctx.lineTo(w,y0);	 // X axis
 ctx.moveTo(x0,0);	  ctx.lineTo(x0,h);	 // Y axis
 ctx.stroke();
}
}


</script>
</head>
<body onload="typeDetermination()">
<div id = "dab"> </div>
<div id = "grab"> </div>
<div id = "dab1"> </div>
<div id = "grab1"> </div>
<style type="text/css">
      canvas { border: 1px solid black; }
    </style>

<script>
//creates canvas element and ataches it to the body of the html Document
if (graphType != "menu"){
var canv = document.createElement('canvas');
canv.id = 'myCanvas';
//sets canvas height and width based on the size of the window. does this once when the page is loaded.
canv.width = document.body.clientWidth-100;
canv.height = document.body.clientHeight-100;
document.body.appendChild(canv);


var canvas = document.getElementById('myCanvas');
var canvasWidth = canvas.width;
var canvasHeight = canvas.height;
var ctx = canvas.getContext("2d");
var axes={};
 axes.x0 = .5 + .5*canvas.width;  // x0 pixels from left to x=0
 axes.y0 = .5 + .5*canvas.height; // y0 pixels from top to y=0
 axes.scale = 40;				  // 40 pixels from x=0 to x=1
 axes.doNegativeX = true;
}


var imageLoaded = false;
var hand = new Image();
var lhand = new Image();
var rgrip = new Image();
var lgrip = new Image();
hand.src='hand.png';
lhand.src='lhand.png';
rgrip.src='rgrip.png';
lgrip.src='lgrip.png';

hand.onload = function(){
imageLoaded=true;
left.push(lhand);
right.push(hand);
}

</script>

</body>
</html>
